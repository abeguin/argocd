apiVersion: apps/v1
kind: Deployment
metadata:
  name: paperless
  labels:
    {{- include "paperless.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: paperless
  template:
    metadata:
      labels:
        app: paperless
    spec:
      containers:
        - name: web
          image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: paperless-env
          env:
            - name: PAPERLESS_DBUSER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: username
            - name: PAPERLESS_DBPASS
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: password
            - name: PAPERLESS_DBNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.database.secretName }}
                  key: database
          volumeMounts:
            - name: data
              mountPath: /usr/src/paperless/data
            - name: media
              mountPath: /usr/src/paperless/media
            - name: export
              mountPath: /usr/src/paperless/export
            - name: consume-tmp
              mountPath: /usr/src/paperless/consume
          resources:
            {{- toYaml .Values.resources.web | nindent 12 }}
          livenessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5

        {{- if .Values.consumeSync.enabled }}
        - name: consume-sync
          image: alpine:3.20
          resources:
            {{- toYaml .Values.resources.consumeSync | nindent 12 }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache rsync inotify-tools
              mkdir -p /mnt/consume /usr/src/paperless/consume
              echo "ðŸ“¦ Starting consume folder sync (host -> tmpfs)..."
              while true; do
                rsync -a --delete /mnt/consume/ /usr/src/paperless/consume/
                inotifywait -r -e modify,create,delete /mnt/consume || sleep 1
              done
          volumeMounts:
            - name: consume-host
              mountPath: /mnt/consume
            - name: consume-tmp
              mountPath: /usr/src/paperless/consume
        {{- end }}

      volumes:
        - name: data
          hostPath:
            path: {{ .Values.volumes.data }}
            type: Directory
        - name: media
          hostPath:
            path: {{ .Values.volumes.media }}
            type: Directory
        - name: export
          hostPath:
            path: {{ .Values.volumes.export }}
            type: Directory
        - name: consume-host
          hostPath:
            path: {{ .Values.volumes.consume }}
            type: Directory
        - name: consume-tmp
          emptyDir:
            medium: "Memory"
